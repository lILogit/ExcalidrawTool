version: '3.8'

# Production Docker Compose configuration for Excalidraw AI Agent
# This file is optimized for production deployment in cloud environments

services:
  excalidraw-app:
    build:
      context: .
      dockerfile: Dockerfile
    image: excalidraw-ai-agent:latest
    container_name: excalidraw-ai-agent
    restart: always
    ports:
      - "${APP_PORT:-80}:80"
    environment:
      # ===========================================
      # AI Provider Configuration
      # ===========================================
      VITE_AI_PROVIDER: ${VITE_AI_PROVIDER}
      VITE_ANTHROPIC_API_KEY: ${VITE_ANTHROPIC_API_KEY}
      VITE_ANTHROPIC_MODEL: ${VITE_ANTHROPIC_MODEL:-claude-sonnet-4-20250514}

      # ===========================================
      # Model Parameters
      # ===========================================
      VITE_AI_MAX_TOKENS: ${VITE_AI_MAX_TOKENS:-4096}
      VITE_AI_TEMPERATURE: ${VITE_AI_TEMPERATURE:-0.7}
      VITE_AI_TOP_P: ${VITE_AI_TOP_P:-0.9}
      VITE_AI_TOP_K: ${VITE_AI_TOP_K:-40}
      VITE_AI_REPEAT_PENALTY: ${VITE_AI_REPEAT_PENALTY:-1.1}

      # ===========================================
      # Retry Configuration
      # ===========================================
      VITE_AI_MAX_RETRIES: ${VITE_AI_MAX_RETRIES:-3}
      VITE_AI_RETRY_DELAY: ${VITE_AI_RETRY_DELAY:-1000}

      # ===========================================
      # Debug & Logging
      # ===========================================
      VITE_AI_DEBUG: ${VITE_AI_DEBUG:-false}
      VITE_LOGGING_ENABLED: ${VITE_LOGGING_ENABLED:-true}
      VITE_LOG_TO_CONSOLE: ${VITE_LOG_TO_CONSOLE:-false}
      VITE_MAX_LOG_ENTRIES: ${VITE_MAX_LOG_ENTRIES:-500}

      # ===========================================
      # N8N Integration
      # ===========================================
      VITE_N8N_WEBHOOK_URL: ${VITE_N8N_WEBHOOK_URL:-}
      VITE_N8N_WEBHOOK_TOKEN: ${VITE_N8N_WEBHOOK_TOKEN:-}
      VITE_N8N_DEBUG: ${VITE_N8N_DEBUG:-false}
      VITE_N8N_CALLBACK_URL: ${VITE_N8N_CALLBACK_URL:-}
    networks:
      - excalidraw-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  excalidraw-network:
    driver: bridge
    name: excalidraw-ai-agent-network
